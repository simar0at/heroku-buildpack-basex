#!/usr/bin/env bash

BUILD_DIR=${1:-}
PORT=${PORT:-8984}

bash -o xtrace "$BUILD_DIR/.heroku/basex/bin/basexhttp" "-h$PORT" >/dev/null 2>&1 &
sleep 0.5
curl --connect-timeout 20 -s -D - "http://localhost:$PORT" -o /dev/null 2>/dev/null | head -n1 | grep -q 200 || exit 1

if yarn --version > /dev/null 2>&1; then
  cd "$BUILD_DIR" && yarn test
else
  cd "$BUILD_DIR" && npm test
fi
