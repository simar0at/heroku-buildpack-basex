#!/usr/bin/env bash
BUILD_DIR=${1:-}
PORT=${PORT:-8984}

bash "$BUILD_DIR/.heroku/basex/bin/basexhttp" "-h$PORT" &
(curl --connect-timeout 5 --max-time 10 --retry 3 --retry-delay 0 --retry-max-time 40 --retry-connrefused 0 -s -D - "http://localhost:$PORT" -o /dev/null | head -n1 | grep -q 200) || (pkill -TERM java; exit 1)

if yarn --version > /dev/null 2>&1; then
  cd "$BUILD_DIR" && yarn test
else
  cd "$BUILD_DIR" && npm test
fi
testResult=$?

"$BUILD_DIR/.heroku/basex/bin/basexhttpstop" 2>&1 | grep 'was stopped'
exit $testResult